#!/bin/sh
# Pre-commit hook: lint, typecheck, test
# Unset git env vars so child git operations in tests target their own repos
unset GIT_DIR GIT_INDEX_FILE GIT_WORK_TREE GIT_OBJECT_DIRECTORY GIT_ALTERNATE_OBJECT_DIRECTORIES

# --- Biome: check staged files using biome's native --staged flag ---
echo "Running biome on staged files..."
bunx biome check --staged --write --no-errors-on-unmatched
if [ $? -ne 0 ]; then
  echo "Biome check failed. Fix issues before committing."
  exit 1
fi

# --- Typecheck (incremental) ---
echo "Running typecheck..."
bun run typecheck
if [ $? -ne 0 ]; then
  echo "Typecheck failed. Fix type errors before committing."
  exit 1
fi

# --- Unit tests (same filter as `bun run test:unit`) ---
echo "Running unit tests..."
bun run test:unit
if [ $? -ne 0 ]; then
  echo "Tests failed. Fix tests before committing."
  exit 1
fi

echo "All checks passed."
